<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>Quản lý Nhập hàng</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container py-4">
  <h3>Quản lý phiếu nhập</h3>
  <div class="mb-3">
    <button class="btn btn-success" onclick="createDemo()">Tạo demo</button>
    <button class="btn btn-primary" onclick="newReceipt()">Thêm phiếu nhập</button>
  </div>
  <input id="searchReceipt" class="form-control mb-3" placeholder="Tìm phiếu theo ngày hoặc mã" oninput="render()">
  <table class="table"><thead><tr><th>Mã</th><th>Ngày</th><th>Tổng tiền</th><th>Trạng thái</th><th>Hành động</th></tr></thead><tbody id="list"></tbody></table>
</div>
<script>
function getReceipts(){ return JSON.parse(localStorage.getItem('receipts')||'[]'); }
function saveReceipts(r){ localStorage.setItem('receipts', JSON.stringify(r)); }
function render(){
  const q = document.getElementById('searchReceipt').value.toLowerCase();
  const rows = getReceipts().filter(r=> r.code.toLowerCase().includes(q) || r.date.includes(q));
  const tbody = document.getElementById('list'); tbody.innerHTML='';
  rows.forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${r.code}</td><td>${r.date}</td><td>${r.total}</td><td>${r.done? 'Hoàn thành':'Chưa'}</td>
      <td>
        <button class="btn btn-sm btn-info" onclick="view(${i})">Xem/Sửa</button>
        <button class="btn btn-sm btn-success" onclick="finish(${i})" ${r.done? 'disabled':''}>Hoàn thành</button>
      </td>`;
    tbody.appendChild(tr);
  });
}
function createDemo(){
  const r=[{code:'PN001', date:'2025-11-01', items:[{code:'C01', qty:2, price:50000}], total:100000, done:false}];
  saveReceipts(r); render(); alert('Demo tạo xong');
}
function newReceipt(){
  const code = 'PN'+Date.now();
  const date = new Date().toISOString().slice(0,10);
  const items = [];
  const price = prompt('Nhập giá nhập cho 1 sản phẩm (demo):','100000');
  const qty = prompt('Số lượng:','1');
  if(price===null||qty===null) return;
  items.push({code:'DEMO', qty:parseInt(qty), price:parseFloat(price)});
  const total = items.reduce((s,i)=>s+i.qty*i.price,0);
  const r = getReceipts(); r.push({code, date, items, total, done:false}); saveReceipts(r); render();
}
function view(i){
  const r=getReceipts()[i];
  alert('Phiếu: '+JSON.stringify(r, null, 2));
  if(r.done) { alert('Đã hoàn thành, không thể sửa (theo yêu cầu).'); return; }
  if(confirm('Chỉnh sửa: đổi số lượng đầu tiên?')) {
    r.items[0].qty = parseInt(prompt('Số lượng mới', r.items[0].qty));
    r.total = r.items.reduce((s,it)=>s+it.qty*it.price,0);
    const arr=getReceipts(); arr[i]=r; saveReceipts(arr); render();
  }
}
function finish(i){ if(!confirm('Đánh dấu hoàn thành?')) return; const a=getReceipts(); a[i].done=true; saveReceipts(a); render(); }
render();
</script>
</body>
</html>
